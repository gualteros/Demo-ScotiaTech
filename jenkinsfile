pipeline {
    agent {
        label "daniel"
    }
    
    
    stages {
        stage('Tf init and validate') {
            steps {

                sh 'terraform -chdir=./Terraform/multicloudk8s init'
                sh 'terraform -chdir=./Terraform/multicloudk8s validate'
                echo 'the validation of terraform is done'                
            }
        }

        stage('Tf apply') {
            steps {
                sh 'terraform -chdir=./Terraform/multicloudk8s apply -auto-approve'
                echo 'the Infrastructure of terraform is done'                
            }
        }

        stage('Preparing CM') {
            steps {
                sh 'cd ansible-ws'
                sh 'ansible-inventory -i ./ansible-ws --graph'
                echo 'run the follow command to connect server by terraform "ssh -i k8s-multi-cloud-key-public ubuntu@<ip-address>"'           
            }
        }

        stage('Running playbook') {
            steps {
                sh 'cd ansible-ws'
                ansiblePlaybook becomeUser: 'daniel', inventory: './ansible-ws', playbook: './ansible-ws/site.yml', sudo: true, sudoUser: 'daniel'
                echo 'The configuration of ubuntu is done'        
            }
        }

        stage('destroying Terraform') {
            steps {
                sh 'terraform -chdir=./Terraform/multicloudk8s destroy -auto-approve'
                echo 'The configuration of ubuntu has gone'        
            }
        }
    }

      post {
    failure {
        sh 'terraform -chdir=./Terraform/multicloudk8s destroy -auto-approve'
    }
  }
}