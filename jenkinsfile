pipeline {
    agent {
        label "daniel"
    }
    
    
    stages {
        stage('Tf init and validate') {
            steps {
                sh 'cd Terraform/multicloudk8s/'
                sh 'ls'
                sh 'terraform init'
                sh 'terraform validate'
                echo 'the validation of terraform is done'                
            }
        }

        stage('Tf apply') {
            steps {
                sh 'cd Terraform/multicloudk8s/'
                sh 'pwd'
                sh 'terraform apply -auto-approve'
                sh 'terraform validate'
                echo 'the validation of terraform is done'                
            }
        }

        stage('Preparing CM') {
            steps {
                sh 'cd ansible-ws'
                sh 'pwd'
                sh 'ls'
                sh 'cat inventory'
                echo 'run the follow command to connect server by terraform "ssh -i k8s-multi-cloud-key-public ubuntu@<ip-address>"'
                sh 'terraform validate'
                echo 'the validation of terraform is done'                
            }
        }

        stage('Running playbook') {
            steps {
                sh 'cd ansible-ws'
                sh 'ansible-inventory --graph'
                sh 'ansible-playbook site.yml'
                echo 'The configuration of ubuntu is done'        
            }
        }

        stage('destroying Terraform') {
            steps {
                sh 'pwd'
                sh 'cd Terraform/multicloudk8s/'
                sh 'ansible-playbook site.yml'
                echo 'The configuration of ubuntu has gone'        
            }
        }
    }
}