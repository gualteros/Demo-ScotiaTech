pipeline {
    agent {
        label "daniel"
    }
    
    
    stages {
        stage('Tf init and validate') {
            steps {

                sh 'terraform -chdir=./Terraform/multicloudk8s init'
                sh 'terraform -chdir=./Terraform/multicloudk8s validate'
                echo 'the validation of terraform is done'                
            }
        }

        stage('Tf apply') {
            steps {
                sh 'terraform -chdir=./Terraform/multicloudk8s apply -auto-approve'
                echo 'the Infrastructure of terraform is done'                
            }
        }

        stage('Preparing CM') {
            steps {
                sh 'cd ansible-ws'
                sh 'ansible-inventory -i ./ansible-ws --graph'
                echo 'run the follow command to connect server by terraform "ssh -i k8s-multi-cloud-key-public ubuntu@<ip-address>"'           
            }
        }

        stage('Running playbook') {
            steps {
                sh 'cd ansible-ws'
                sh 'sudo ansible-playbook ./ansible-ws/site.yml'
                echo 'The configuration of ubuntu is done'        
            }
        }

        stage('destroying Terraform') {
            steps {
                sh 'terraform -chdir=./Terraform/multicloudk8s destroy -auto-approve'
                echo 'The configuration of ubuntu has gone'        
            }
        }

        stage('build/maven') {
            steps {
                sh 'mvn clean compile install -DskipTests -f=./k8s-camel/'
                echo 'Build the proyect is ok'        
            }
        }

        stage("Unit Test") {
            steps {
                echo "Init Unit Test"
                sh "mvn test camel:route-coverage -f ./k8s-camel/"
                echo "End Unit Test"
            }
        }

        stage("Build Image/Docker") {
            steps {
                echo "Init build image with docker"
                sh "docker build ./k8s-camel/ -t demoscotia"
                echo "End Building the image"
            }
        }

        stage("deploy and run Image to cluster") {
            steps {
                echo "Running image with docker"
                sh "minikube image load demoscotia:latest"
                sh "kubectl apply -f ./k8s-camel/configuration/openshift/template-ms-fuse-dev.yml"
                echo "Running pod"
            }
        }
    }

      post {
    failure {
        sh 'terraform -chdir=./Terraform/multicloudk8s destroy -auto-approve'
    }

  }
}